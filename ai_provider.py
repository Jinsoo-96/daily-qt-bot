from google import genai  # ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ë¦„ì´ 'google-genai'ì´ì§€ë§Œ importëŠ” 'google.genai' í˜¹ì€ 'google'ì—ì„œ í•©ë‹ˆë‹¤.
from google.genai import types
import os
import time

def get_ai_reflection(bible_title, bible_range, content_body):
    client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))
    
    prompt = f"""
ë‹¹ì‹ ì€ ë‘ ì—­í• ì„ ë™ì‹œì— ìˆ˜í–‰í•©ë‹ˆë‹¤.

1) ì„±ê²½ ì¤‘ì‹¬ì˜ ê¸°ë…êµ ì„¸ê³„ê´€ ìœ„ì—ì„œ,
   ë³µìŒì£¼ì˜ ì‹ í•™ ì „í†µì— ê¸°ë°˜í•œ ë›°ì–´ë‚œ ì„±ì„œì‹ í•™ì
2) ë”°ëœ»í•˜ê³  ë¬¸í•™ì ì¸ ë¬µìƒ ì—ì„¸ì´ë¥¼ ì“°ëŠ” ì‘ê°€

ì•„ë˜ì— ì œê³µëœ [ì„±ê²½ ë³¸ë¬¸]ì„ ê¸°ë°˜ìœ¼ë¡œ
ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ìœ„í•œ íí‹° ë¬µìƒ ê¸€ì„ ì‘ì„±í•œë‹¤.

[ì‘ì„± ê·œì¹™]
- ì „ì²´ ë¶„ëŸ‰ì€ ê³µë°± í¬í•¨ 2000ì ì´ë‚´ë¡œ ì‘ì„±í•œë‹¤.
- í•œêµ­ì–´ë¡œ ì‘ì„±í•œë‹¤
- ê³¼ë„í•œ ì„¤êµì²´ë‚˜ êµí›ˆì  í‘œí˜„ì€ í”¼í•˜ê³ , ì°¨ë¶„í•˜ê³  ë”°ëœ»í•œ í†¤ì„ ìœ ì§€í•œë‹¤
- ì‹ í•™ì  í•´ì„¤ê³¼ ë¬µìƒ ì—ì„¸ì´ê°€ ìì—°ìŠ¤ëŸ½ê²Œ í•˜ë‚˜ì˜ íë¦„ìœ¼ë¡œ ì´ì–´ì§€ë„ë¡ í•œë‹¤
- ë³¸ë¬¸ì— ì—†ëŠ” ë‚´ìš©ì„ ë‹¨ì •ì ìœ¼ë¡œ ì¶”ê°€í•˜ì§€ ì•ŠëŠ”ë‹¤
- ë…ìì˜ ì¼ìƒê³¼ ì—°ê²°ë˜ëŠ” ë¬µìƒì  ì ìš©ì„ í¬í•¨í•œë‹¤
- 20~30ëŒ€ ì‹ ì•™ì¸ì´ ê²ªëŠ” í˜„ì‹¤ì ì¸ ê³ ë¯¼(ì§„ë¡œ, ê´€ê³„, ë¶ˆì•ˆ, ë°˜ë³µë˜ëŠ” ì¼ìƒ ë“±)ì„ ì€ê·¼íˆ ë°˜ì˜í•œë‹¤
- 20ëŒ€ ì´ˆë°˜ë¶€í„° 30ëŒ€ í›„ë°˜ê¹Œì§€ ëª¨ë‘ ê³µê°í•  ìˆ˜ ìˆëŠ”, íŠ¹ì • ì‚¶ì˜ ë‹¨ê³„ì— ì¹˜ìš°ì¹˜ì§€ ì•Šì€ ì¤‘ë¦½ì ì¸ ì¼ìƒ ì–¸ì–´ë¥¼ ì‚¬ìš©í•œë‹¤
- ë…ìë¥¼ ë‹¤ê·¸ì¹˜ê±°ë‚˜ í‰ê°€í•˜ì§€ ì•ŠëŠ”ë‹¤
- ë””ìŠ¤ì½”ë“œì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ê°€ë…ì„± ì¢‹ê²Œ ì‘ì„±í•œë‹¤.


[ì¶œë ¥ í˜•ì‹ â€” ë°˜ë“œì‹œ ê·¸ëŒ€ë¡œ ë”°ë¥¸ë‹¤]

## ì˜¤ëŠ˜ì„ ìœ„í•œ ë¬µìƒ: (ë³¸ë¬¸ì„ ë°˜ì˜í•œ ì§§ê³  ë”°ëœ»í•œ ì œëª©)

### ë³¸ë¬¸ í•´ì„¤: ì†Œì œëª©
> í•˜ë‚˜ì˜ ì¸ìš© ë¸”ë¡ ì•ˆì—ì„œ ì¤„ë°”ê¿ˆì„ ì‚¬ìš©í•´ ë¬¸ë‹¨ì„ êµ¬ë¶„í•œë‹¤(ì¸ìš© ë¸”ë¡ì´ ëŠì–´ì§€ì§€ ì•Šë„ë¡ ì£¼ì˜í•  ê²ƒ)
> ë‚´ìš©
> ë‚´ìš©

### ë¬µìƒ ì—ì„¸ì´: í•˜ìœ„ ë‚´ìš©ì— ì–´ìš¸ë¦¬ëŠ” ì†Œì œëª©ì„ ë°˜ë“œì‹œ ìƒì„±í•œë‹¤
> í•˜ë‚˜ì˜ ì¸ìš© ë¸”ë¡ ì•ˆì—ì„œ ì¤„ë°”ê¿ˆì„ ì‚¬ìš©í•´ ë¬¸ë‹¨ì„ êµ¬ë¶„í•œë‹¤(ì¸ìš© ë¸”ë¡ì´ ëŠì–´ì§€ì§€ ì•Šë„ë¡ ì£¼ì˜í•  ê²ƒ)
> ë‚´ìš©
> ë‚´ìš©

### í•˜ë£¨ë¥¼ ìœ„í•œ ë¬µìƒ ì§ˆë¬¸ 3ê°€ì§€
1. **ì†Œì œëª©**
   > ì§ˆë¬¸ ë‚´ìš©

2. **ì†Œì œëª©**
   > ì§ˆë¬¸ ë‚´ìš©

3. **ì†Œì œëª©**
   > ì§ˆë¬¸ ë‚´ìš©


[ì‘ì„± ë‚´ìš© ìƒì„¸]

### ë³¸ë¬¸ í•´ì„¤: í•˜ìœ„ ë‚´ìš©ì— ì–´ìš¸ë¦¬ëŠ” ì†Œì œëª©ì„ ë°˜ë“œì‹œ ìƒì„±í•œë‹¤
> ë³¸ë¬¸ì˜ ì—­ì‚¬ì Â·ë¬¸ë§¥ì  ì˜ë¯¸ì™€ í•µì‹¬ ì‹ í•™ ì£¼ì œë¥¼ ë‹´ëŠ”ë‹¤
> ë³¸ë¬¸ í•´ì„¤ì€ ìµœì†Œ 2~3ê°œì˜ ë¬¸ë‹¨ìœ¼ë¡œ ì¶©ë¶„íˆ í’€ì–´ë‚¸ë‹¤
> ë³¸ë¬¸ í•´ì„¤ì—ì„œ ë¬µìƒ ì—ì„¸ì´ë¡œ ë„˜ì–´ê°ˆ ë•Œ, ì˜ë¯¸ì˜ ë‹¤ë¦¬ ì—­í• ì„ í•˜ëŠ” ì „í™˜ ë¬¸ë‹¨ì„ í¬í•¨í•œë‹¤

### ë¬µìƒ ì—ì„¸ì´: í•˜ìœ„ ë‚´ìš©ì— ì–´ìš¸ë¦¬ëŠ” ì†Œì œëª©ì„ ë°˜ë“œì‹œ ìƒì„±í•œë‹¤
> ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ì‚´ì•„ê°€ëŠ” ì‹ ì•™ì¸ì˜ ë§ˆìŒì— ì¡°ìš©íˆ ë§ì„ ê±´ë„¤ëŠ” ë¬¸ì²´ë¡œ ì‘ì„±í•œë‹¤
> ë¬µìƒ ì—ì„¸ì´ëŠ” ì„œë‘â€“ì¤‘ì‹¬â€“ì—¬ìš´ì˜ íë¦„ìœ¼ë¡œ ë¹„êµì  ì¶©ë¶„íˆ ì„œìˆ í•œë‹¤
> ë¬µìƒ ì—ì„¸ì´ì˜ ë§ˆì§€ë§‰ì—ëŠ”, í•„ìš”í•  ê²½ìš° ì—¬ìš´ì„ ë‚¨ê¸°ëŠ” ì§§ì€ ë‹¨ë… ë¬¸ë‹¨ì„ ë‘˜ ìˆ˜ ìˆë‹¤

### í•˜ë£¨ë¥¼ ìœ„í•œ ë¬µìƒ ì§ˆë¬¸ 3ê°€ì§€
> ê° ì§ˆë¬¸ì€ ìƒê°ì„ ì—´ì–´ë‘ëŠ” ì§ˆë¬¸ìœ¼ë¡œ ì‘ì„±í•œë‹¤
> í•˜ë£¨ë¥¼ ì •ë¦¬í•˜ê±°ë‚˜ ê²°ë¡ ì§“ëŠ” ëŠë‚Œì€ í”¼í•œë‹¤
> ê° ì§ˆë¬¸ì€ ë‹µì„ ìš”êµ¬í•˜ì§€ ì•Šê³ , ìƒê°ê³¼ ê¸°ë„ê°€ ì´ì–´ì§€ë„ë¡ ì—¬ë°±ì„ ë‚¨ê¸´ë‹¤
> ìƒê°í•´ë³¼ ë§Œí•œ ê³ ë¯¼ì´ë‚˜, í•˜ë£¨ë¥¼ ì‹œì‘í•˜ê±°ë‚˜ í’ˆê³  ê°ˆ ìˆ˜ ìˆëŠ” ì§ˆë¬¸ìœ¼ë¡œ êµ¬ì„±í•œë‹¤
> ê²°ë‹¨Â·ë§ˆë¬´ë¦¬Â·í‰ê°€í˜• ì§ˆë¬¸ ê¸ˆì§€


[ì„±ê²½ ë³¸ë¬¸]
{bible_title}
{bible_range}
{content_body}
"""
    max_retries = 3  # ìµœëŒ€ 3ë²ˆ ì‹œë„
    retry_delay = 2  # ì‹¤íŒ¨ ì‹œ 2ì´ˆ ëŒ€ê¸° í›„ ë‹¤ì‹œ ì‹œë„
    # ì•ˆì „ ì„¤ì •: ì„±ê²½ ë³¸ë¬¸ ë¶„ì„ ì¤‘ ì°¨ë‹¨ë˜ëŠ” ì¼ì„ ë°©ì§€í•©ë‹ˆë‹¤.
    # 2. ì•ˆì „ ì„¤ì • (í™•ì‹¤í•œ ìµœì‹  ë¬¸ë²•ì…ë‹ˆë‹¤)
    # ì„±ê²½ ë³¸ë¬¸ì˜ íŠ¹ì • ë‹¨ì–´ê°€ ì°¨ë‹¨ë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ BLOCK_NONEìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
    config = types.GenerateContentConfig(
        safety_settings=[
            types.SafetySetting(category='HARM_CATEGORY_HARASSMENT', threshold='BLOCK_NONE'),
            types.SafetySetting(category='HARM_CATEGORY_HATE_SPEECH', threshold='BLOCK_NONE'),
            types.SafetySetting(category='HARM_CATEGORY_DANGEROUS_CONTENT', threshold='BLOCK_NONE'),
            types.SafetySetting(category='HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold='BLOCK_NONE'),
        ]
    )
    
    for attempt in range(max_retries):
        try:
            print(f"ğŸ¤– AI ì‘ë‹µ ìƒì„± ì¤‘... (ì‹œë„ {attempt + 1}/{max_retries})")
            # 3. ì½˜í…ì¸  ìƒì„± (ìµœì‹  ë¬¸ë²•: client.models.generate_content)
            response = client.models.generate_content(
                model='gemini-3-flash-preview',
                contents=prompt,
                config=config)
            
            # ì‘ë‹µì´ ì„±ê³µì ìœ¼ë¡œ ì™”ê³  í…ìŠ¤íŠ¸ê°€ ìˆëŠ” ê²½ìš°
            if response and response.text:
               # 1. ì¼ë‹¨ ëª¨ë“  '>' ë’¤ì— ê³µë°±ì„ ë¶™ì…ë‹ˆë‹¤.
               content = response.text.replace('>', '> ')
               
               # 2. í˜¹ì‹œ ì´ë¯¸ ê³µë°±ì´ ìˆì–´ì„œ '>  'ê°€ ë˜ì–´ë²„ë¦° ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë‹¤ì‹œ '> 'ë¡œ ì •ë ¬í•©ë‹ˆë‹¤.
               fixed_content = content.replace('>  ', '> ')
               
               return fixed_content
            
            # ì‘ë‹µì€ ì™”ìœ¼ë‚˜ í…ìŠ¤íŠ¸ê°€ ì—†ëŠ” ê²½ìš° (Safety Filter ì‘ë™ ë“±)
            else:
                print("âš ï¸ AI ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.")
                
        except Exception as e:
            print(f"âŒ ì‹œë„ {attempt + 1} ì‹¤íŒ¨: {e}")
            if attempt < max_retries - 1:
                time.sleep(retry_delay) # ì ì‹œ ëŒ€ê¸° í›„ ë‹¤ìŒ ë£¨í”„ ì§„í–‰
            else:
                # ëª¨ë“  ì‹œë„ê°€ ì‹¤íŒ¨í–ˆì„ ë•Œ ë³´ë‚¼ ë©”ì‹œì§€
                return "ğŸ™ í˜„ì¬ AIê°€ ë¬µìƒì„ ì¤€ë¹„í•˜ëŠ” ë° ì–´ë ¤ì›€ì„ ê²ªê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”."

    return "ğŸ™ ë¬µìƒ ë‚´ìš©ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
